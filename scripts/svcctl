#!/bin/bash

# svcctl - Service Control for macOS (kubectl-style interface)
# A unified interface for managing launchd services on macOS

set -euo pipefail

# Configuration
CONFIG_FILE="$HOME/.svcctl/config.json"
SERVICES_DIR="$HOME/.svcctl/services"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

# Initialize config directory
mkdir -p "$(dirname "$CONFIG_FILE")" "$SERVICES_DIR"

# Function to register a service
register_service() {
    local name=$1
    local plist_path=$2
    local description=${3:-""}
    
    cat > "$SERVICES_DIR/$name.json" <<EOF
{
    "name": "$name",
    "plist": "$plist_path",
    "description": "$description",
    "registered": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
}
EOF
    echo -e "${GREEN}✓${NC} Service '$name' registered"
}

# Function to get all registered services
get_registered_services() {
    local services=()
    if [[ -d "$SERVICES_DIR" ]]; then
        for file in "$SERVICES_DIR"/*.json; do
            if [[ -f "$file" ]]; then
                local name=$(basename "$file" .json)
                services+=("$name")
            fi
        done
    fi
    if [[ ${#services[@]} -gt 0 ]]; then
        echo "${services[@]}"
    fi
}

# Auto-discover services
auto_discover() {
    echo -e "${CYAN}Auto-discovering services...${NC}"
    
    local count=0
    for plist in ~/Library/LaunchAgents/*.plist /Library/LaunchAgents/*.plist; do
        if [[ -f "$plist" ]]; then
            local service_name=$(basename "$plist" .plist)
            if [[ ! -f "$SERVICES_DIR/$service_name.json" ]]; then
                register_service "$service_name" "$plist" "Auto-discovered"
                ((count++))
            fi
        fi
    done
    
    echo -e "${GREEN}Discovered $count new services${NC}"
}

# Get service status
get_status() {
    local service=$1
    local launchctl_status=$(launchctl list | grep "$service" 2>/dev/null || echo "")
    
    if [[ -z "$launchctl_status" ]]; then
        echo "NotLoaded"
    else
        local pid=$(echo "$launchctl_status" | awk '{print $1}')
        if [[ "$pid" == "-" ]]; then
            echo "Stopped"
        else
            echo "Running"
        fi
    fi
}

# Get service command
get_command() {
    local service=$1
    local plist_path=""
    
    if [[ -f "$SERVICES_DIR/$service.json" ]]; then
        plist_path=$(grep '"plist"' "$SERVICES_DIR/$service.json" | cut -d'"' -f4)
    else
        # Try to find it
        for path in ~/Library/LaunchAgents /Library/LaunchAgents; do
            if [[ -f "$path/$service.plist" ]]; then
                plist_path="$path/$service.plist"
                break
            fi
        done
    fi
    
    if [[ -n "$plist_path" ]] && [[ -f "$plist_path" ]]; then
        local program=$(/usr/libexec/PlistBuddy -c "Print :Program" "$plist_path" 2>/dev/null || \
                       /usr/libexec/PlistBuddy -c "Print :ProgramArguments:0" "$plist_path" 2>/dev/null || \
                       echo "unknown")
        echo "$program"
    else
        echo "unknown"
    fi
}

# kubectl-style get command
cmd_get() {
    local resource=${1:-services}
    
    case "$resource" in
        services|svc)
            echo -e "${BOLD}NAME                                     STATUS       COMMAND${NC}"
            
            # Get all services
            local all_services=()
            
            # Registered services
            local registered=$(get_registered_services)
            if [[ -n "$registered" ]]; then
                for service in $registered; do
                    all_services+=("$service")
                done
            fi
            
            # Running services not registered
            while IFS= read -r line; do
                if [[ -n "$line" ]]; then
                    local service=$(echo "$line" | awk '{print $3}')
                    if [[ ! " ${all_services[@]} " =~ " ${service} " ]]; then
                        all_services+=("$service")
                    fi
                fi
            done < <(launchctl list | grep -E "com\.|local\.|dev\.|homebrew\." 2>/dev/null || true)
            
            # Sort and display
            local sorted=()
            if [[ ${#all_services[@]} -gt 0 ]]; then
                IFS=$'\n' sorted=($(sort <<<"${all_services[*]}")); unset IFS
            fi
            
            for service in "${sorted[@]}"; do
                local status=$(get_status "$service")
                local cmd=$(get_command "$service")
                
                # Color code status
                case "$status" in
                    Running)
                        status="${GREEN}Running${NC}"
                        ;;
                    Stopped)
                        status="${YELLOW}Stopped${NC}"
                        ;;
                    NotLoaded)
                        status="${RED}NotLoaded${NC}"
                        ;;
                esac
                
                # Truncate command for display
                if [[ ${#cmd} -gt 40 ]]; then
                    cmd="...$(echo "$cmd" | tail -c 37)"
                fi
                
                printf "%-40s ${status}      %s\n" "$service" "$cmd"
            done
            ;;
            
        nodes)
            echo -e "${BOLD}NAME         STATUS    ROLES    VERSION          OS${NC}"
            local hostname=$(hostname -s)
            local version=$(sw_vers -productVersion)
            local arch=$(uname -m)
            printf "%-12s ${GREEN}Ready${NC}     master   %-16s macOS/$arch\n" "$hostname" "$version"
            ;;
            
        *)
            echo -e "${RED}Error: Unknown resource type: $resource${NC}"
            echo "Available resources: services, svc, nodes"
            return 1
            ;;
    esac
}

# kubectl-style describe command
cmd_describe() {
    local resource=$1
    local name=$2
    
    if [[ -z "$name" ]]; then
        echo -e "${RED}Error: Name required${NC}"
        echo "Usage: svcctl describe service <name>"
        return 1
    fi
    
    echo -e "${BOLD}Name:${NC}         $name"
    echo -e "${BOLD}Status:${NC}       $(get_status "$name")"
    
    # Find plist
    local plist_path=""
    for path in ~/Library/LaunchAgents /Library/LaunchAgents /Library/LaunchDaemons; do
        if [[ -f "$path/$name.plist" ]]; then
            plist_path="$path/$name.plist"
            break
        fi
    done
    
    if [[ -n "$plist_path" ]]; then
        echo -e "${BOLD}Config:${NC}       $plist_path"
        
        local program=$(/usr/libexec/PlistBuddy -c "Print :Program" "$plist_path" 2>/dev/null || echo "")
        [[ -n "$program" ]] && echo -e "${BOLD}Program:${NC}      $program"
        
        local workdir=$(/usr/libexec/PlistBuddy -c "Print :WorkingDirectory" "$plist_path" 2>/dev/null || echo "")
        [[ -n "$workdir" ]] && echo -e "${BOLD}WorkDir:${NC}      $workdir"
        
        local runAtLoad=$(/usr/libexec/PlistBuddy -c "Print :RunAtLoad" "$plist_path" 2>/dev/null || echo "false")
        echo -e "${BOLD}AutoStart:${NC}    $runAtLoad"
        
        local stdout=$(/usr/libexec/PlistBuddy -c "Print :StandardOutPath" "$plist_path" 2>/dev/null || echo "")
        [[ -n "$stdout" ]] && echo -e "${BOLD}Stdout:${NC}       $stdout"
        
        local stderr=$(/usr/libexec/PlistBuddy -c "Print :StandardErrorPath" "$plist_path" 2>/dev/null || echo "")
        [[ -n "$stderr" ]] && echo -e "${BOLD}Stderr:${NC}       $stderr"
    fi
    
    # Get process info if running
    local launchctl_info=$(launchctl list | grep "$name" 2>/dev/null || echo "")
    if [[ -n "$launchctl_info" ]]; then
        local pid=$(echo "$launchctl_info" | awk '{print $1}')
        if [[ "$pid" != "-" ]]; then
            echo ""
            echo -e "${BOLD}Process Info:${NC}"
            ps -p "$pid" -o pid,ppid,%cpu,%mem,start,time,command | tail -n +1
        fi
    fi
}

# kubectl-style logs command
cmd_logs() {
    local service=$1
    local follow=${2:-false}
    
    if [[ -z "$service" ]]; then
        echo -e "${RED}Error: Service name required${NC}"
        echo "Usage: svcctl logs <service> [-f]"
        return 1
    fi
    
    # Find log files
    local plist_path=""
    for path in ~/Library/LaunchAgents /Library/LaunchAgents /Library/LaunchDaemons; do
        if [[ -f "$path/$service.plist" ]]; then
            plist_path="$path/$service.plist"
            break
        fi
    done
    
    if [[ -z "$plist_path" ]]; then
        # Try generic log locations
        local log_files=()
        [[ -f "/tmp/$service.log" ]] && log_files+=("/tmp/$service.log")
        [[ -f "/tmp/$service-output.log" ]] && log_files+=("/tmp/$service-output.log")
        [[ -f "/tmp/$service-error.log" ]] && log_files+=("/tmp/$service-error.log")
        
        if [[ ${#log_files[@]} -gt 0 ]]; then
            if [[ "$follow" == "true" ]] || [[ "$follow" == "-f" ]]; then
                tail -f "${log_files[@]}"
            else
                tail -n 50 "${log_files[@]}"
            fi
        else
            echo -e "${RED}No log files found for service: $service${NC}"
        fi
    else
        local stdout=$(/usr/libexec/PlistBuddy -c "Print :StandardOutPath" "$plist_path" 2>/dev/null || echo "")
        local stderr=$(/usr/libexec/PlistBuddy -c "Print :StandardErrorPath" "$plist_path" 2>/dev/null || echo "")
        
        local log_files=()
        [[ -n "$stdout" ]] && [[ -f "$stdout" ]] && log_files+=("$stdout")
        [[ -n "$stderr" ]] && [[ -f "$stderr" ]] && log_files+=("$stderr")
        
        if [[ ${#log_files[@]} -gt 0 ]]; then
            if [[ "$follow" == "true" ]] || [[ "$follow" == "-f" ]]; then
                tail -f "${log_files[@]}"
            else
                tail -n 50 "${log_files[@]}"
            fi
        else
            echo -e "${RED}No log files found for service: $service${NC}"
        fi
    fi
}

# Service control commands
cmd_start() {
    local service=$1
    echo -e "${CYAN}Starting $service...${NC}"
    launchctl start "$service"
    sleep 1
    
    local status=$(get_status "$service")
    if [[ "$status" == "Running" ]]; then
        echo -e "${GREEN}✓${NC} Service started"
    else
        echo -e "${YELLOW}⚠${NC} Service may not have started correctly"
    fi
}

cmd_stop() {
    local service=$1
    echo -e "${CYAN}Stopping $service...${NC}"
    launchctl stop "$service"
    echo -e "${GREEN}✓${NC} Stop signal sent"
}

cmd_restart() {
    local service=$1
    cmd_stop "$service"
    sleep 2
    cmd_start "$service"
}

# Main help
show_help() {
    cat <<EOF
${BOLD}svcctl - Service Control for macOS${NC}
A kubectl-style interface for managing launchd services

${BOLD}Usage:${NC}
  svcctl <command> [options]

${BOLD}Available Commands:${NC}
  get <resource>         Display resources (services, nodes)
  describe <svc> <name>  Show details of a service
  logs <service> [-f]    Print logs from a service
  start <service>        Start a service
  stop <service>         Stop a service
  restart <service>      Restart a service
  discover              Auto-discover services
  
${BOLD}Examples:${NC}
  svcctl get services           # List all services
  svcctl get svc               # Short form
  svcctl describe svc com.gamecode.web
  svcctl logs com.gamecode.web
  svcctl logs com.gamecode.web -f  # Follow logs
  svcctl start com.gamecode.web
  svcctl restart ollama

${BOLD}Aliases:${NC}
  svc = services
  
EOF
}

# Main command router
case "${1:-help}" in
    get)
        cmd_get "${2:-services}"
        ;;
    describe)
        cmd_describe "${2:-service}" "${3:-}"
        ;;
    logs)
        cmd_logs "${2:-}" "${3:-}"
        ;;
    start)
        cmd_start "${2:-}"
        ;;
    stop)
        cmd_stop "${2:-}"
        ;;
    restart)
        cmd_restart "${2:-}"
        ;;
    discover)
        auto_discover
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$1'${NC}"
        show_help
        exit 1
        ;;
esac